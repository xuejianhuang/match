<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>赛事管理</title>
<link href="css/style.css" rel="stylesheet" type="text/css" />
<link href="css/css.css" rel="stylesheet" type="text/css" />
<link href="css/97zzw.css" rel="stylesheet" type="text/css" />

<link rel="stylesheet" type="text/css"
	href="/matchPlatform/plugins/easyui/themes/default/easyui.css"/>
	<link rel="stylesheet" type="text/css"
		href="/matchPlatform/plugins/easyui/themes/icon.css"/>
		<link rel="stylesheet" type="text/css"
			href="/matchPlatform/plugins/contentTools/content-tools.min.css"/>


			<script type="text/javascript" src="/matchPlatform/js/jquery.min.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/easyui/common_fn.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/easyui/jquery.easyui.min.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/easyui/locale/easyui-lang-zh_CN.js"></script>
			<!-- datagrid-detailview.js一定要放在 easyui/jquery.easyui.min.js之后-->
			<script type="text/javascript"
				src="/matchPlatform/plugins/easyui/datagrid-detailview.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/datePicker/WdatePicker.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/contentTools/content-tools.min.js"></script>
			<script type="text/javascript"
				src="/matchPlatform/plugins/ajaxUpload/ajaxUpload.js"></script>
			<script type="text/javascript">
				var groupMemberMathProjectId, matchExpandRowIndex;
				function setSearchYear() {
					var startYear = 2013;
					var date = new Date();
					var currentYear = date.getFullYear();
					var json = '[{"value":0,"text":"全部"}';

					for (var i = startYear; i <= currentYear; i++) {
						json += ",{";
						if (i != currentYear) {
							json += '"value":' + i + ',"text":' + i + "}";

						} else {
							json += '"value":' + i + ',"text":' + i
									+ ',"selected":' + true + "}";
						}
					}
					json += "]";
					var data = $.parseJSON(json);
					$("#cmb_selectYear").combobox("loadData", data);

				}

				function selectChange(val) {
					var year = $("#cmb_selectYear").combobox('getValue');
					$('#dg_match').datagrid(
							{
								url : '/matchPlatform/public/searchMatch?_'
										+ new Date().getTime(),
								queryParams : {
									year : year
								}
							});
					/* $('#dg_match').datagrid(
							'load',
							{
								year : year,
							}); */

				}
				function formatOper(val, row, index) {

					var innerHtml = '<a href="#" onclick="openGroupMemberList('
							+ row.id + ')">报名团队</a>';
					if (val == true) {
						innerHtml += ' &nbsp; &nbsp;&nbsp;<a href="#" onclick="startRegister('
								+ row.id + ',' + index + ')">开始报名</a>';

					} else {
						innerHtml += ' &nbsp; &nbsp;&nbsp;<a href="#" style="color: red;"  onclick="stopRegister('
								+ row.id + ',' + index + ')">停止报名</a>';
					}
					//	alert(row.itid);
					return innerHtml;
				}
				function formatterMatchDetail(val, row, index) {
					var	innerHtml = '<a href="/matchPlatform/public/index?code='+val+'">查看详情</a>';
					return innerHtml;
				}
				function openGroupMemberList(matchProjectId) {
					//alert(matchProjectId);
					groupMemberMathProjectId = matchProjectId;
					newDialog('../memberGroup/groupMemberList.html', '参赛名单', 425, 1000);
					//var rows = $('#dg_matchNav').datagrid('getRows');
					//dg_match_ddv
					//alert(row);

				}
				function stopRegister(matchProjectId, index) {
					ajaxSend('/matchPlatform/public/lockMatchProject', {
						id : matchProjectId
					}, function() {
						$('#dg_match_ddv-' + matchExpandRowIndex).datagrid(
								"reload");

					});

				}
				function startRegister(matchProjectId, index) {
					ajaxSend('/matchPlatform/public/unLockMatchProject', {
						id : matchProjectId
					}, function() {
						$('#dg_match_ddv-' + matchExpandRowIndex).datagrid(
								"reload");
					});

				}
				/* memberdoubleclick=function(rowIndex,rowData)
				{
					 doubleclickedit('member_edit.html','修改卡内信息','200','460','ca_editCard.action','dg_member',rowData)
				} */

				$(function() {
					$("#cmb_selectYear").combobox({
						onChange : selectChange,
						valueField : 'value',
						textField : 'text',
						multiple : false,
						onLoadSuccess : function() {

						}
					});
					setSearchYear();

					$('#dg_match')
							.datagrid(
									{
										view : detailview,
										detailFormatter : function(index, row) {
											return '<div style="padding:2px"><table id="dg_match_ddv-' + index + '"></table></div>';
										},
										onExpandRow : function(index, row) {
											matchExpandRowIndex = index;
											$('#dg_match_ddv-' + index)
													.datagrid(
															{

																url : '/matchPlatform/public/searchMatchProject?matchId='
																		+ row.id
																		+ "&_"
																		+ new Date()
																				.getTime(),
																fitColumns : true,
																singleSelect : false,
																remoteSort : false,
																rownumbers : true,
																toolbar : [
																		{
																			text : '添加',
																			iconCls : 'icon-add',
																			handler : function() {
																				add(
																						'../matchProject/matchProject_add.html',
																						'赛项添加',
																						'600',
																						'800',
																						'/matchPlatform/public/addMatchProject?year='
																								+ row.year
																								+ '&matchCode='
																								+ row.code
																								+ '&_'
																								+ new Date()
																										.getTime(),
																						'dg_match_ddv-'
																								+ index,
																						'true');
																			}
																		},
																		{
																			text : '修改',
																			iconCls : 'icon-add',
																			handler : function() {
																				edit(
																						'../matchProject/matchProject_edit.html',
																						'赛项修改',
																						'600',
																						'800',
																						'/matchPlatform/public/editMatchProject?'
																								+ new Date()
																										.getTime(),
																						'dg_match_ddv-'
																								+ index,
																						'true',
																						'ture');
																			}
																		},
																		{
																			text : '删除',
																			iconCls : 'icon-add',
																			handler : function() {
																				del(
																						'/matchPlatform/public/deleteMatchProject?'
																								+ new Date()
																										.getTime(),
																						'dg_match_ddv-'
																								+ index);
																			}
																		} ],
																columns : [ [
																		{
																			field : 'ck',
																			checkbox : true
																		},

																		{
																			field : 'caption',
																			align : 'center',
																			sortable : 'true',
																			title : '赛项名称',
																			width : 50
																		},

																		{
																			field : 'groupMemberCount',
																			align : 'center',
																			sortable : 'true',
																			title : '团队人数',
																			width : 10
																		},

																		{
																			field : 'matchStartDateTime',
																			align : 'center',
																			sortable : 'true',
																			title : '开始时间',
																			width : 30
																		},

																		{
																			field : 'matchEndDateTime',
																			align : 'center',
																			sortable : 'true',
																			title : '结束时间',
																			width : 30
																		}
																		/*  , {
																		field : 'package_',
																		title : '游览类型',
																		align:'center',
																		width : 20
																		}*/
																		,
																		{
																			field : 'isLocked',
																			title : '操作',
																			sortable : 'true',
																			align : 'center',
																			formatter : formatOper,
																			width : 20
																		} ] ],
																onResize : function() {
																	$(
																			'#dg_match')
																			.datagrid(
																					'fixDetailRowHeight',
																					index);
																},
																onLoadSuccess : function() {
																	setTimeout(
																			function() {
																				$(
																						'#dg_match')
																						.datagrid(
																								'fixDetailRowHeight',
																								index);
																			},
																			0);
																}
															});
											$('#dg_match')
													.datagrid(
															'fixDetailRowHeight',
															index);
										}
									});

				});
			</script>
</head>
<body>
	<div style="margin:1px 0;"></div>
	<table id="dg_match" class="easyui-datagrid" title="赛事列表" style=""
		data-options="
		singleSelect:true,
        fitColumns:true,
        collapsible:true,
		method:'get',
		   remoteSort:false,
		toolbar:'#dg_match_tb',
		footer:'#dg_match_ft'">
		<thead>
			<tr>
				<th data-options="field:'ck',checkbox:true"></th>
				<th
					data-options="field:'id',width:20,align:'center',sortable:true">ID</th>
				<th
					data-options="field:'caption',width:100,align:'center',sortable:true">赛事名称</th>
					<th
					data-options="field:'sponsor',width:80,align:'center',sortable:true">主办方</th>
				<th
					data-options="field:'organizerOverLord',width:80,align:'center',sortable:true">总承办</th>
				<th
					data-options="field:'organizer',width:80,align:'center',sortable:true">承办</th>
				<th
					data-options="field:'code',width:50,align:'center',sortable:true" formatter="formatterMatchDetail">详情</th>
			</tr>
		</thead>
	</table>
	<div id="dg_match_tb" style="padding:6px 10px;">
		<!-- Date From: <input class="easyui-datebox" style="width:110px">
		To: <input class="easyui-datebox" style="width:110px"> -->
		赛事年份: <select class="easyui-combobox" panelHeight="auto"
			style="width:100px" id="cmb_selectYear">
		</select> 上移:<a href="#" onclick=" moveUp('dg_match')"
			class="easyui-linkbutton" iconCls="icon-arrow-up" plain="true"></a>
		下移:<a href="#" onclick=" moveDown('dg_match')"
			class="easyui-linkbutton" iconCls="icon-arrow-down" plain="true"></a>
		<!-- 	 <a href="#" class="easyui-linkbutton" iconCls="icon-search">Search</a> -->
	</div>
	<div id="dg_match_ft" style="padding:2px 5px;">
		<a href="#" 
			onclick="add('match_add.html','赛事添加','600','800','/matchPlatform/public/addMatch','dg_match','true')"
			class="easyui-linkbutton" iconCls="icon-add" plain="true"></a> <a
			href="#"
			onclick=" edit('match_edit.html','赛事修改','600','800','/matchPlatform/public/editMatch','dg_match','true','true')"
			class="easyui-linkbutton" iconCls="icon-edit" plain="true"></a> <a
			href="#" onclick=" del('/matchPlatform/public//deleteMatch','dg_match')"
			class="easyui-linkbutton" iconCls="icon-cut" plain="true"></a>
	</div>
</body>
</html>